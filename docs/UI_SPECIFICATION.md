# UI仕様書 - プレス成形解析条件設定アプリ

## 概要

LS-DYNA用のプレス成形シミュレーション解析条件を設定し、kファイル（入力デッキ）をエクスポートするWebアプリケーション。

**フレームワーク**: NiceGUI (Python)

---

## 画面構成

```
┌─────────────────────────────────────────────────────────────┐
│  ヘッダー: アプリタイトル                                    │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 1. 解析概要                                          │    │
│  │    - プロジェクト名                                   │    │
│  │    - 加工分類                                        │    │
│  │    - 解析目的                                        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 2. メッシュ管理                                       │    │
│  │    - kファイルアップロード                            │    │
│  │    - アップロード済みメッシュ一覧                      │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 3. 工程・パート設定 【サイドバー方式】                 │    │
│  │    ┌─────────┬───────────────────────────────────┐  │    │
│  │    │工程一覧  │  選択中の工程の詳細設定           │  │    │
│  │    │         │  - ワーク設定（複数）             │  │    │
│  │    │ 1.曲げ  │  - 工具設定（複数）               │  │    │
│  │    │ 2.絞り  │                                   │  │    │
│  │    │ [+追加] │                                   │  │    │
│  │    └─────────┴───────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 4. 全体設定                                          │    │
│  │    - 摩擦係数                                        │    │
│  │    - 対称面                                          │    │
│  │    - 拘束条件                                        │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 5. エクスポート                                       │    │
│  │    - ファイル名設定                                   │    │
│  │    - エクスポート実行                                 │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 1. 解析概要

### 1.1 プロジェクト名
- **入力形式**: テキスト入力
- **必須**: はい
- **用途**: 出力ファイルのコメント、ファイル名のデフォルト値に使用
- **バリデーション**: 空白不可、ファイル名に使用できない文字は警告

### 1.2 加工分類
- **入力形式**: セレクトボックス（単一選択）
- **選択肢**:
  | 値 | 表示名 |
  |---|---|
  | `bending` | 曲げ加工 |
  | `drawing` | 絞り加工 |
  | `stretching` | 張り出し加工 |
  | `other` | その他 |
- **デフォルト**: 曲げ加工
- **用途**: メタデータ（出力ファイルのコメントに含める）

> **📌 将来拡張**: 加工分類に応じてデフォルト設定（工具配置、摩擦係数など）を自動設定する機能を追加予定。設計時に拡張性を考慮すること。

### 1.3 解析目的
- **入力形式**: セレクトボックス（単一選択）
- **選択肢**:
  | 値 | 表示名 |
  |---|---|
  | `mechanism` | メカニズム確認 |
  | `formability` | 成形性検証 |
  | `optimization` | 条件最適化 |
  | `other` | その他 |
- **デフォルト**: メカニズム確認
- **用途**: メタデータ

> **📌 将来拡張**: 解析目的に応じた推奨設定の提示機能を追加予定。

---

## 2. メッシュ管理

### 2.1 ファイルアップロード
- **対応形式**: `.k` ファイルのみ
- **複数アップロード**: 対応
- **ファイルサイズ上限**: 50MB（暫定）
- **アップロード方式**: ドラッグ&ドロップ または ファイル選択ダイアログ

### 2.2 メッシュ情報リスト

アップロードされたkファイルをシンプルなリスト形式で表示。
詳細情報はパート設定でのメッシュ選択時に確認可能。

| 表示項目 | 説明 |
|---|---|
| ファイル名 | アップロードしたファイル名 |
| パート名 | *PART のタイトル |
| 要素数 | 要素（*ELEMENT_SHELL等）の数 |
| 使用状況 | ✓ 使用中 / ⚠ 未割当 |

- **操作**: 各メッシュに対して削除ボタン
- **複数パート対応**: 1つのkファイルに複数パートが含まれる場合、パートごとに分割して表示

### 2.3 UI表示例

```
┌─ 2. メッシュ管理 ───────────────────────────────────────────────────────┐
│                                                                         │
│  [+ ファイルをアップロード] または ドラッグ&ドロップ                    │
│                                                                         │
│  ┌─ アップロード済み ───────────────────────────────────────────────┐   │
│  │                                                                   │   │
│  │  📄 blank.k      Part 1: ブランク      要素: 5,000   ✓ 使用中   │   │
│  │  📄 punch.k      Part 2: パンチ        要素: 2,000   ✓ 使用中   │   │
│  │  📄 die.k        Part 3: ダイ          要素: 3,000   ⚠ 未割当   │   │
│  │  📄 holder.k     Part 4: ホルダー      要素: 1,500   ✓ 使用中   │   │
│  │                                                                   │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 2.4 節点・要素共有の表示

1つのkファイルに複数パートが含まれ、節点や要素が共有されている場合は注意マークと共に表示。

```
📄 part_a.k    Part 1: 上型      要素: 3,000   ⚠ 節点共有あり   ✓ 使用中
📄 part_a.k    Part 2: 下型      要素: 2,500   ⚠ 節点共有あり   ✓ 使用中
```

- **表示条件**: 同一kファイル内の他パートと節点を共有している場合
- **注意マーク**: ⚠ アイコン + 「節点共有あり」テキスト
- **ホバー/詳細**: 共有先のパート情報を表示（オプション）

---

## 3. 工程・パート設定

### 3.0 レイアウト概要（サイドバー方式）

多工程に対応するため、**サイドバー + メインパネル方式**を採用。
左側に工程一覧、右側に選択した工程の詳細設定を表示。

```
┌─────────────────────────────────────────────────────────────────────────┐
│ 3. 工程・パート設定                                                     │
├───────────────────┬─────────────────────────────────────────────────────┤
│ 工程一覧           │  工程 1: 曲げ加工                                  │
│                   │                                                     │
│ ┌───────────────┐ │  ┌─ 工程情報 ─────────────────────────────────────┐ │
│ │ ● 1. 曲げ  ← │ │  │  工程名: [曲げ加工      ]                       │ │
│ └───────────────┘ │  │  工程タイプ: [▼ 曲げ加工]                       │ │
│ ┌───────────────┐ │  └─────────────────────────────────────────────────┘ │
│ │   2. 絞り     │ │                                                     │
│ └───────────────┘ │  ┌─ ワーク設定 ───────────────────────────────────┐ │
│ ┌───────────────┐ │  │  ワーク 1: ブランク                             │ │
│ │   3. 仕上げ   │ │  │  [メッシュ▼] [材質▼] 板厚: [1.0] mm           │ │
│ └───────────────┘ │  │  [+ ワークを追加]                               │ │
│                   │  └─────────────────────────────────────────────────┘ │
│ [+ 工程を追加]    │                                                     │
│                   │  ┌─ 工具設定 ─────────────────────────────────────┐ │
│ ─────────────────  │  │  工具 1: パンチ                                 │ │
│ 工程の順序         │  │  [メッシュ▼] [変位] [▼-Z] [50.0]mm [1.0]ms   │ │
│ [↑ 上へ] [↓ 下へ] │  │                                                 │ │
│                   │  │  工具 2: ダイ                                   │ │
│ ─────────────────  │  │  [メッシュ▼] [固定]                            │ │
│ [複製] [削除]     │  │  [+ 工具を追加]                                 │ │
│                   │  └─────────────────────────────────────────────────┘ │
└───────────────────┴─────────────────────────────────────────────────────┘
```

### 3.1 工程管理

#### 3.1.1 工程一覧（サイドバー）

| 機能 | 説明 |
|---|---|
| 工程追加 | 「+ 工程を追加」ボタンで新規工程を追加 |
| 工程選択 | クリックで工程を選択、メインパネルに詳細表示 |
| 順序変更 | 「↑ 上へ」「↓ 下へ」ボタンで工程順を変更 |
| 工程複製 | 選択中の工程を複製（設定を引き継ぎ） |
| 工程削除 | 選択中の工程を削除（確認ダイアログ表示） |

#### 3.1.2 工程情報

| 項目 | 入力形式 | 説明 |
|---|---|---|
| 工程名 | テキスト | 任意の識別名（例: 1次曲げ、仕上げ絞り）|
| 工程タイプ | セレクトボックス | 曲げ / 絞り / 張り出し / その他 |

- **工程タイプ**: メタデータとして保存（将来的にデフォルト設定連動に活用）
- **工程名**: サイドバーの一覧表示にも使用

#### 3.1.3 工程の初期状態
- **最低数**: 1工程
- **初期状態**: 1つの工程が作成され、選択された状態

---

### 3.2 ワーク設定（工程ごと）

各工程に対して、ワークを設定。

#### 基本仕様
- **複数設定**: 可能（追加/削除ボタン）
- **最低数**: 1つ
- **初期状態**: 1つのワークカードが表示

#### 3.2.1 ワークごとの設定項目

| 項目 | 入力形式 | 説明 |
|---|---|---|
| ワーク名 | テキスト | 任意の識別名（例: ブランク、素材）|
| メッシュ割り当て | セレクトボックス | アップロード済みメッシュから選択 |
| 材質 | セレクトボックス | プリセットまたはカスタム |
| 板厚 | 数値入力 | シェル要素の板厚 (mm) |

#### 3.2.2 メッシュ選択UI

メッシュ選択時に詳細情報を折りたたみ式で表示。

**セレクトボックス展開時:**
```
│ メッシュ: [▼ 選択してください                   ]│
│           ┌─────────────────────────────────────┐│
│           │ 🔍 検索...                          ││
│           ├─────────────────────────────────────┤│
│           │   blank.k (Part 1: ブランク)        ││
│           │   punch.k (Part 2: パンチ)          ││
│           │   die.k (Part 3: ダイ)              ││
│           ├─────────────────────────────────────┤│
│           │ [+ 新規アップロード]                ││
│           └─────────────────────────────────────┘│
```

**メッシュ選択後（詳細は折りたたみ）:**
```
│ メッシュ: [▼ blank.k (Part 1)]  [▶ 詳細]        │
│ 材質:     [▼ 軟鋼 (SPCC)]                       │
│ 板厚:     [1.0    ] mm                           │
```

**詳細を展開した状態:**
```
│ メッシュ: [▼ blank.k (Part 1)]  [▼ 詳細]        │
│   ┌─────────────────────────────────────────┐    │
│   │ 📄 blank.k                               │    │
│   │ パート: Part 1 (ブランク)                │    │
│   │ 要素数: 5,000 / 節点数: 5,200            │    │
│   │ 要素タイプ: SHELL                        │    │
│   │                                           │    │
│   │ 📎 他の割り当て:                         │    │
│   │    工程2 → ワーク1                       │    │
│   └─────────────────────────────────────────┘    │
│ 材質:     [▼ 軟鋼 (SPCC)]                       │
│ 板厚:     [1.0    ] mm                           │
```

**詳細情報の表示項目:**
| 項目 | 説明 |
|---|---|
| ファイル名 | アップロードしたファイル名 |
| パート名 | *PART のタイトル |
| 要素数 / 節点数 | メッシュの規模 |
| 要素タイプ | SHELL / SOLID 等 |
| 他の割り当て | 同じメッシュが他の工程・パートで使用されている場合に表示 |

#### 3.2.3 材質
- **入力形式**: セレクトボックス + マニュアル入力切替
- **プリセット選択肢**:
  | 材質名 | 密度 (ton/mm³) | ヤング率 (MPa) | ポアソン比 | 降伏応力 (MPa) |
  |---|---|---|---|---|
  | 軟鋼 (SPCC) | 7.83e-9 | 207,000 | 0.28 | 280 |
  | ステンレス鋼 (SUS304) | 7.93e-9 | 193,000 | 0.29 | 205 |
  | ステンレス鋼 (SUS305) | 7.93e-9 | 193,000 | 0.29 | 205 |
  | アルミニウム合金 (A5052) | 2.68e-9 | 70,000 | 0.33 | 195 |
  | アルミニウム合金 (A6061-T6) | 2.70e-9 | 68,900 | 0.33 | 276 |
  | 銅合金 (C1100) | 8.96e-9 | 118,000 | 0.34 | 70 |
  | チタン合金 (Ti-6Al-4V) | 4.43e-9 | 113,800 | 0.34 | 880 |
  | カスタム | - | - | - | - |

- **カスタム選択時の入力項目**:
  - 密度 (ton/mm³)
  - ヤング率 (MPa)
  - ポアソン比
  - 降伏応力 (MPa)
  - 接線係数 (MPa) ※オプション

#### 3.2.4 板厚
- **入力形式**: 数値入力
- **単位**: mm
- **範囲**: 0.01 ~ 10.0 mm
- **デフォルト**: 1.0 mm
- **ステップ**: 0.01

#### 3.2.5 ワーク設定 UI表示例

```
┌─ ワーク設定 ───────────────────────────────────────────────────┐
│                                                               │
│  ┌─ ワーク 1 ─────────────────────────────────────── [削除] ─┐│
│  │ ワーク名:  [ブランク        ]                             ││
│  │ メッシュ:  [▼ blank.k (Part 1)]                          ││
│  │ 材質:      [▼ 軟鋼 (SPCC)]                               ││
│  │ 板厚:      [1.0     ] mm                                  ││
│  └───────────────────────────────────────────────────────────┘│
│                                                               │
│  [+ ワークを追加]                                             │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

---

### 3.3 工具設定（工程ごと）

各工程に対して、工具を設定。

#### 基本仕様
- **複数設定**: 可能（追加/削除ボタン）
- **最低数**: 1つ
- **初期状態**: 1つの工具カードが表示

#### 3.3.1 工具ごとの設定項目

| 項目 | 入力形式 | 説明 |
|---|---|---|
| 工具名 | テキスト | 任意の識別名（例: パンチ、ダイ）|
| メッシュ割り当て | セレクトボックス | アップロード済みメッシュから選択 |
| 動作タイプ | トグルボタン | 変位 / 荷重 / 固定 |
| 動作方向 | セレクトボックス | +X / -X / +Y / -Y / +Z / -Z |
| 動作値 | 数値入力 | 動作タイプに応じた値 |
| 動作時間 | 数値入力 | 動作完了までの時間 (ms) |

※ メッシュ選択UIはワーク設定と同様（折りたたみ式詳細表示、セクション3.2.2参照）
| 動作時間 | 数値入力 | 動作完了までの時間 (ms) |

#### 3.3.2 動作タイプ別の入力

| 動作タイプ | 方向入力 | 値入力 | 時間入力 | 単位 |
|---|---|---|---|---|
| 変位 | 必要 | 必要 | 必要 | mm, ms |
| 荷重 | 必要 | 必要 | 必要 | N, ms |
| 固定 | 不要 | 不要 | 不要 | - |

#### 3.3.3 動作方向の選択肢
- **+X**: X軸正方向
- **-X**: X軸負方向
- **+Y**: Y軸正方向
- **-Y**: Y軸負方向
- **+Z**: Z軸正方向
- **-Z**: Z軸負方向

> **📌 将来拡張（任意ベクトル）**: 斜め方向など任意のベクトル入力をサポート予定。UIは実装時にコメントアウト状態で準備。
> 
> ```
> 任意ベクトル:  Vx: [    ] Vy: [    ] Vz: [    ]
> ```

#### 3.3.4 動作時間
- **入力形式**: 数値入力
- **単位**: ms（ミリ秒）
- **デフォルト**: 1.0 ms
- **範囲**: 0.001 ~ 10000.0 ms

#### 3.3.5 工具設定 UI表示例

```
┌─ 工具設定 ─────────────────────────────────────────────────────┐
│                                                               │
│  ┌─ 工具 1 ───────────────────────────────────────── [削除] ─┐│
│  │ 工具名:    [パンチ          ]                             ││
│  │ メッシュ:  [▼ mesh_punch.k (Part 2)]                     ││
│  │                                                           ││
│  │ 動作タイプ: [変位] [荷重] [固定]  ← トグル選択            ││
│  │                                                           ││
│  │ 動作方向:  [▼ -Z]                                        ││
│  │ 変位量:    [50.0    ] mm                                  ││
│  │ 動作時間:  [1.0     ] ms                                  ││
│  └───────────────────────────────────────────────────────────┘│
│                                                               │
│  ┌─ 工具 2 ───────────────────────────────────────── [削除] ─┐│
│  │ 工具名:    [ダイ            ]                             ││
│  │ メッシュ:  [▼ mesh_die.k (Part 3)]                       ││
│  │                                                           ││
│  │ 動作タイプ: [変位] [荷重] [固定]  ← 固定選択時は下記非表示 ││
│  └───────────────────────────────────────────────────────────┘│
│                                                               │
│  [+ 工具を追加]                                               │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

> **📌 将来拡張（速度制御）**: 変位・荷重に加え、速度制御オプションを追加予定。既存の`Tool`クラスには対応済み。

---

## 4. 全体設定

### 4.1 摩擦係数

#### 入力形式
- **選択方式**: ラジオボタン + 条件付き入力

#### 選択肢
| 選択肢 | 静摩擦係数 | 動摩擦係数 | 備考 |
|---|---|---|---|
| 油あり | 0.10 | 0.05 | プリセット値 ✅ |
| 油なし | 0.15 | 0.10 | プリセット値 ✅ |
| マニュアル入力 | (ユーザー入力) | (ユーザー入力) | 自由入力 |

#### マニュアル入力時
- **静摩擦係数**: 数値入力（0.0 ~ 1.0）
- **動摩擦係数**: 数値入力（0.0 ~ 1.0）
- **バリデーション**: 動摩擦 ≤ 静摩擦

---

### 4.2 対称面

#### 目的
解析モデルを対称性を利用して1/2、1/4モデルとする際の対称境界条件

#### 入力形式
- **有効化**: チェックボックス
- **複数設定**: 可能（最大2面 = 1/4モデル）

#### 設定項目（各対称面ごと）
| 項目 | 入力形式 | 説明 |
|---|---|---|
| 平面 | セレクトボックス | XY / YZ / ZX |
| 座標 | 数値入力 | 平面の位置（例: X=0） |

#### UI表示例
```
☑ 対称面を使用

  対称面 1:  平面 [▼ YZ]  座標 X = [0.0    ] mm
  
  [+ 対称面を追加]
```

---

### 4.3 任意の拘束条件

#### 目的
特定の座標・領域のノードに対する自由度拘束を設定

#### 入力形式
- **複数設定**: 可能（追加/削除）

#### 設定項目（各拘束条件ごと）
| 項目 | 入力形式 | 説明 |
|---|---|---|
| 名前 | テキスト | 拘束条件の識別名 |
| 座標範囲 | 数値入力×6 | Xmin, Xmax, Ymin, Ymax, Zmin, Zmax |
| 拘束する自由度 | チェックボックス×6 | X並進, Y並進, Z並進, X回転, Y回転, Z回転 |

#### UI表示例
```
☑ 拘束条件を追加

  拘束条件 1: [端部固定     ]                         [削除]
  ─────────────────────────────────────────────────────
  座標範囲:
    X: [-100.0  ] ~ [100.0   ] mm
    Y: [-50.0   ] ~ [50.0    ] mm  
    Z: [0.0     ] ~ [0.0     ] mm
  
  拘束する自由度:
    ☑ X並進  ☑ Y並進  ☑ Z並進
    ☐ X回転  ☐ Y回転  ☐ Z回転
    
  [+ 拘束条件を追加]
```

> **【要確認】**
> - 座標範囲指定以外の方法（パート選択、ノードセット名など）は必要？
> - 点拘束（特定座標のノード1点）のサポートは必要？

---

## 5. エクスポート

### 5.1 条件ファイル名
- **入力形式**: テキスト入力
- **デフォルト**: プロジェクト名から自動生成（例: `{project_name}`）
- **拡張子**: メインファイルは `.dyn` を自動付与
- **バリデーション**: ファイル名として有効な文字のみ

### 5.2 エクスポート実行
- **ボタン**: 「エクスポート」
- **動作**: 設定内容を検証後、ファイルを生成してダウンロード（ZIP形式）
- **エラー時**: バリデーションエラーを画面に表示

### 5.3 出力ファイル構成

**方式B採用**: 分割ファイル出力（*INCLUDE使用）、工程ごとにフォルダ分割

```
{project_name}/
├── step_1/                   # 工程1フォルダ
│   ├── main.dyn              # 工程1メインファイル（*INCLUDEで他を参照）
│   ├── mesh/                 # 工程1メッシュファイル
│   │   ├── work_1.k
│   │   ├── work_2.k
│   │   ├── tool_1.k
│   │   ├── tool_2.k
│   │   └── ...
│   ├── materials.k           # 材料定義
│   ├── sections.k            # セクション定義
│   ├── contacts.k            # 接触定義
│   ├── boundary.k            # 境界条件（対称面、拘束）
│   └── control.k             # 制御カード（時間設定等）
│
├── step_2/                   # 工程2フォルダ
│   ├── main.dyn
│   ├── mesh/
│   │   └── ...
│   ├── materials.k
│   ├── sections.k
│   ├── contacts.k
│   ├── boundary.k
│   └── control.k
│
└── step_n/                   # 工程nフォルダ
    └── ...
```

※ 単一工程の場合も同じ構成（`step_1/` フォルダのみ）

> **📌 多工程エクスポートの詳細**: 工程間でのdynainファイル連携などは実装時に詳細を決定

#### main.dyn の構造例（step_1/main.dyn）
```
*KEYWORD
*TITLE
{project_name} - Step 1: {step_name}
$
$ Generated by Press Forming Analysis Tool
$ Project: {project_name}
$ Step: 1 / {total_steps}
$ Date: YYYY-MM-DD HH:MM:SS
$
*INCLUDE
mesh/work_1.k
*INCLUDE
mesh/tool_1.k
*INCLUDE
mesh/tool_2.k
*INCLUDE
materials.k
*INCLUDE
sections.k
*INCLUDE
contacts.k
*INCLUDE
boundary.k
*INCLUDE
control.k
*END
```

---

## データモデル（内部状態）

```python
from dataclasses import dataclass, field
from typing import List, Optional, Tuple
from enum import Enum


class ProcessType(Enum):
    """加工分類"""
    BENDING = "bending"
    DRAWING = "drawing"
    STRETCHING = "stretching"
    OTHER = "other"


class AnalysisPurpose(Enum):
    """解析目的"""
    MECHANISM = "mechanism"
    FORMABILITY = "formability"
    OPTIMIZATION = "optimization"
    OTHER = "other"


class MotionType(Enum):
    """動作タイプ"""
    DISPLACEMENT = "displacement"
    LOAD = "load"
    FIXED = "fixed"
    # VELOCITY = "velocity"  # 将来追加予定


class FrictionMode(Enum):
    """摩擦モード"""
    OIL = "oil"        # 油あり: 静摩擦0.10, 動摩擦0.05
    DRY = "dry"        # 油なし: 静摩擦0.15, 動摩擦0.10
    MANUAL = "manual"  # マニュアル入力


class Direction(Enum):
    """動作方向"""
    POSITIVE_X = "+x"
    NEGATIVE_X = "-x"
    POSITIVE_Y = "+y"
    NEGATIVE_Y = "-y"
    POSITIVE_Z = "+z"
    NEGATIVE_Z = "-z"
    # CUSTOM = "custom"  # 将来追加予定: 任意ベクトル


@dataclass
class MaterialProperties:
    """材料特性"""
    density: float              # 密度 (ton/mm³)
    youngs_modulus: float       # ヤング率 (MPa)
    poisson_ratio: float        # ポアソン比
    yield_stress: float         # 降伏応力 (MPa)
    tangent_modulus: float = 0.0  # 接線係数 (MPa)


@dataclass
class MeshInfo:
    """アップロードされたメッシュ情報"""
    id: str                     # 一意のID（UUID等）
    file_name: str              # オリジナルファイル名
    file_path: str              # サーバー上の一時保存パス
    part_id: int                # *PART で定義されたID
    part_name: str              # *PART のタイトル
    element_count: int          # 要素数
    node_count: int             # 節点数


@dataclass
class WorkpieceConfig:
    """ワーク設定"""
    id: str                     # 一意のID
    name: str                   # ワーク名
    mesh_id: str                # MeshInfoへの参照
    material_preset: str        # プリセット名 or "custom"
    custom_material: Optional[MaterialProperties] = None
    thickness: float = 1.0      # 板厚 (mm)


@dataclass 
class ToolConfig:
    """工具設定"""
    id: str                     # 一意のID
    name: str                   # 工具名
    mesh_id: str                # MeshInfoへの参照
    motion_type: MotionType     # 動作タイプ
    direction: Optional[Direction] = None  # 動作方向
    value: Optional[float] = None          # 変位量(mm) or 荷重(N)
    motion_time: float = 1.0    # 動作時間 (ms) ※デフォルト: 1ms
    # custom_vector: Optional[Tuple[float, float, float]] = None  # 将来追加予定


@dataclass
class FrictionConfig:
    """摩擦設定"""
    mode: FrictionMode
    static_friction: float = 0.10   # 静摩擦係数
    dynamic_friction: float = 0.05  # 動摩擦係数
    
    def apply_preset(self) -> None:
        """プリセット値を適用"""
        if self.mode == FrictionMode.OIL:
            self.static_friction = 0.10
            self.dynamic_friction = 0.05
        elif self.mode == FrictionMode.DRY:
            self.static_friction = 0.15
            self.dynamic_friction = 0.10


@dataclass
class SymmetryPlane:
    """対称面設定"""
    plane: str                  # "xy", "yz", "zx"
    coordinate: float           # 平面の位置


@dataclass
class ConstraintConfig:
    """拘束条件設定"""
    id: str                     # 一意のID
    name: str                   # 拘束条件名
    x_range: Tuple[float, float]  # X座標範囲 (min, max)
    y_range: Tuple[float, float]  # Y座標範囲 (min, max)
    z_range: Tuple[float, float]  # Z座標範囲 (min, max)
    dof: List[bool] = field(default_factory=lambda: [False] * 6)
    # dof: [tx, ty, tz, rx, ry, rz] - True=拘束, False=自由


@dataclass
class StepConfig:
    """工程設定（1工程分のワーク・工具設定をまとめる）"""
    id: str                     # 一意のID（UUID等）
    name: str                   # 工程名（例: "1次曲げ"）
    step_type: ProcessType      # 工程タイプ（曲げ/絞り/張り出し/その他）
    order: int                  # 工程の順序（1, 2, 3, ...）
    
    # 工程ごとのパート設定
    workpieces: List[WorkpieceConfig] = field(default_factory=list)
    tools: List[ToolConfig] = field(default_factory=list)


@dataclass
class AnalysisConfig:
    """解析設定全体を管理するデータクラス"""
    
    # 解析概要
    project_name: str = "untitled"
    process_type: ProcessType = ProcessType.BENDING      # プロジェクト全体の主な加工分類
    analysis_purpose: AnalysisPurpose = AnalysisPurpose.MECHANISM
    
    # メッシュ情報（全工程で共有）
    uploaded_meshes: List[MeshInfo] = field(default_factory=list)
    
    # 工程設定（複数工程対応）
    steps: List[StepConfig] = field(default_factory=list)
    
    # 全体設定（全工程で共有）
    friction: FrictionConfig = field(default_factory=lambda: FrictionConfig(mode=FrictionMode.OIL))
    symmetry_planes: List[SymmetryPlane] = field(default_factory=list)
    constraints: List[ConstraintConfig] = field(default_factory=list)
    
    # エクスポート
    output_filename: str = ""  # 空の場合はproject_nameを使用
    
    @property
    def step_count(self) -> int:
        """工程数を取得"""
        return len(self.steps)
    
    def get_step_by_order(self, order: int) -> Optional[StepConfig]:
        """順序番号で工程を取得"""
        for step in self.steps:
            if step.order == order:
                return step
        return None
```

---

## 将来拡張

| 機能 | 概要 | 備考 |
|---|---|---|
| **モデル表示・ノード選択** | 3Dビューア上でノードを選択して拘束条件を設定 | 拘束条件の対象指定方法として追加 |
| **設定の保存・読み込み** | 解析設定をファイルに保存し、再利用・複製可能にする | JSON形式での保存を想定 |
| **3Dプレビュー** | アップロードしたメッシュや設定内容を可視化 | PyVistaを使用予定 |
| **任意ベクトル方向** | 工具の動作方向を任意のベクトルで指定 | UIは準備してコメントアウト |
| **速度制御** | 工具の動作タイプに速度制御を追加 | 既存コードは対応済み |
| **加工分類連動** | 加工分類に応じたデフォルト設定の自動適用 | メタデータから設定連動へ |

---

## 画面遷移・ワークフロー

```
[開始]
   ↓
[1. 解析概要入力]
   ↓
[2. メッシュアップロード]
   ↓
[3. 工程・パート設定]  ← サイドバー方式
   │
   ├─→ [工程1] ─→ ワーク設定 + 工具設定
   ├─→ [工程2] ─→ ワーク設定 + 工具設定
   └─→ [工程n] ─→ ワーク設定 + 工具設定
   ↓
[4. 全体設定]
   ↓
[5. エクスポート設定]
   ↓
[エクスポート実行] → [ZIPダウンロード]
   ↓
[完了]
```

※ 基本的にシングルページ（スクロール形式）で、上から順に入力していく想定
※ 工程・パート設定はサイドバー方式で、複数工程を効率的に管理

---

## 更新履歴

| 日付 | 更新内容 |
|---|---|
| 2024-12-26 | 初版作成 |
| 2024-12-26 | 仕様確定: 摩擦係数、動作時間、エクスポート方式、ワーク複数対応等 |
| 2024-12-26 | 多工程対応: サイドバー方式のUIレイアウト追加、StepConfigデータモデル追加 |
| 2024-12-26 | メッシュ管理: 分離型＋インライン詳細表示（折りたたみ式）に決定 |
